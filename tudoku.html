<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tudoku</title>



<style>



body {
    font-family: "Arial", sans-serif;
}

section {
    text-align: center;
}

.game--container {
    display: grid;
    grid-template-columns: repeat(9, auto);
    width: 460px;
    margin: 50px auto;
}


.game--column {
    display: grid;
    grid-template-rows: repeat(9, auto);
    width: 50px;
    cursor: pointer;

}

.cell {
    width: 49px;
    height: 49px;

    
    box-shadow: 0 0 0 1px #333333;
    border: 1px solid #333333;
    border-radius: 15%;

    font-family: "Permanent Marker", cursive;
    line-height: 50px;
    font-size: 50px;

}

.del--cell{
    background-color: firebrick;
}


.next--number {
    font-family: "Permanent Marker", cursive;
    width: 50px;
    height: 50px;
    box-shadow: 0 0 0 1px #333333;
    border: 1px solid #333333;
    border-radius: 15%;
    line-height: 50px;
    font-size: 50px;
    margin: 50px auto;


}

.game--column > .cell {
    pointer-events: none;
  }
</style>



</head>
<body>
    <section>
        <h1 class="game--title">Tudoku</h1>
        <div class="game--container">
            <div data-col-index="0" class="game--column">
                <div data-cell-index="00" class="cell"></div>
                <div data-cell-index="10" class="cell"></div>
                <div data-cell-index="20" class="cell"></div>
                <div data-cell-index="30" class="cell"></div>
                <div data-cell-index="40" class="cell"></div>
                <div data-cell-index="50" class="cell"></div>
                <div data-cell-index="60" class="cell"></div>
                <div data-cell-index="70" class="cell"></div>
                <div data-cell-index="80" class="cell"></div>
                </div>
                <div data-col-index="1" class="game--column">
                <div data-cell-index="01" class="cell"></div>
                <div data-cell-index="11" class="cell"></div>
                <div data-cell-index="21" class="cell"></div>
                <div data-cell-index="31" class="cell"></div>
                <div data-cell-index="41" class="cell"></div>
                <div data-cell-index="51" class="cell"></div>
                <div data-cell-index="61" class="cell"></div>
                <div data-cell-index="71" class="cell"></div>
                <div data-cell-index="81" class="cell"></div>
                </div>
                <div data-col-index="2" class="game--column">
                <div data-cell-index="02" class="cell"></div>
                <div data-cell-index="12" class="cell"></div>
                <div data-cell-index="22" class="cell"></div>
                <div data-cell-index="32" class="cell"></div>
                <div data-cell-index="42" class="cell"></div>
                <div data-cell-index="52" class="cell"></div>
                <div data-cell-index="62" class="cell"></div>
                <div data-cell-index="72" class="cell"></div>
                <div data-cell-index="82" class="cell"></div>
                </div>
                <div data-col-index="3" class="game--column">
                <div data-cell-index="03" class="cell"></div>
                <div data-cell-index="13" class="cell"></div>
                <div data-cell-index="23" class="cell"></div>
                <div data-cell-index="33" class="cell"></div>
                <div data-cell-index="43" class="cell"></div>
                <div data-cell-index="53" class="cell"></div>
                <div data-cell-index="63" class="cell"></div>
                <div data-cell-index="73" class="cell"></div>
                <div data-cell-index="83" class="cell"></div>
                </div>
                <div data-col-index="4" class="game--column">
                <div data-cell-index="04" class="cell"></div>
                <div data-cell-index="14" class="cell"></div>
                <div data-cell-index="24" class="cell"></div>
                <div data-cell-index="34" class="cell"></div>
                <div data-cell-index="44" class="cell"></div>
                <div data-cell-index="54" class="cell"></div>
                <div data-cell-index="64" class="cell"></div>
                <div data-cell-index="74" class="cell"></div>
                <div data-cell-index="84" class="cell"></div>
                </div>
                <div data-col-index="5" class="game--column">
                <div data-cell-index="05" class="cell"></div>
                <div data-cell-index="15" class="cell"></div>
                <div data-cell-index="25" class="cell"></div>
                <div data-cell-index="35" class="cell"></div>
                <div data-cell-index="45" class="cell"></div>
                <div data-cell-index="55" class="cell"></div>
                <div data-cell-index="65" class="cell"></div>
                <div data-cell-index="75" class="cell"></div>
                <div data-cell-index="85" class="cell"></div>
                </div>
                <div data-col-index="6" class="game--column">
                <div data-cell-index="06" class="cell"></div>
                <div data-cell-index="16" class="cell"></div>
                <div data-cell-index="26" class="cell"></div>
                <div data-cell-index="36" class="cell"></div>
                <div data-cell-index="46" class="cell"></div>
                <div data-cell-index="56" class="cell"></div>
                <div data-cell-index="66" class="cell"></div>
                <div data-cell-index="76" class="cell"></div>
                <div data-cell-index="86" class="cell"></div>
                </div>
                <div data-col-index="7" class="game--column">
                <div data-cell-index="07" class="cell"></div>
                <div data-cell-index="17" class="cell"></div>
                <div data-cell-index="27" class="cell"></div>
                <div data-cell-index="37" class="cell"></div>
                <div data-cell-index="47" class="cell"></div>
                <div data-cell-index="57" class="cell"></div>
                <div data-cell-index="67" class="cell"></div>
                <div data-cell-index="77" class="cell"></div>
                <div data-cell-index="87" class="cell"></div>
                </div>
                <div data-col-index="8" class="game--column">
                <div data-cell-index="08" class="cell"></div>
                <div data-cell-index="18" class="cell"></div>
                <div data-cell-index="28" class="cell"></div>
                <div data-cell-index="38" class="cell"></div>
                <div data-cell-index="48" class="cell"></div>
                <div data-cell-index="58" class="cell"></div>
                <div data-cell-index="68" class="cell"></div>
                <div data-cell-index="78" class="cell"></div>
                <div data-cell-index="88" class="cell"></div>
                </div>

        </div>
        <div class = "next--number"> </div>
        <h2 class="game--status"></h2>
        <button class="game--restart">Restart Game</button>
    </section>




    <script>

        let game_active = true;
    
        let game_state = Array(9).fill().map(() => Array(9).fill(0));


        let col_top_index = [8,8,8,8,8,8,8,8,8];
    
        let next_number = 0;

        const next_number_display = document.querySelector('.next--number');


        function random_uniform_int(min,max,top){
            min = Math.floor(min);
            max = Math.floor(max) - min;
            top = Math.floor(top);
            let occur = Array(max).fill(0);
        
            function random_int(){
                let temp = [];
                for (let i = 0; i<max; i++){
                    if (top - occur[i] > 0) {
                        //console.log(i,occur,occur.length);
                        temp = temp.concat(Array(top - occur[i]).fill(min+i));
                    }
                }
                
                let index = Math.floor(Math.random() * temp.length);
                let val = temp[index];
                //console.log(val,temp,index);
                occur[val-min]++;
        
                //reset occur
        
                let minimum = Math.min(...occur);
                console.log(minimum,occur);
        
                if (minimum > 0){
                    for (let i = 0; i<max; i++){
                        occur[i] = occur[i] - minimum;
                    }
                }
                return val;
            }
        
            random_int.min = min;
            random_int.max = max;
            random_int.top = top;
            random_int.occur = occur;
        
            return random_int;
        
        }

        let random = random_uniform_int(1,10,3);

        function restart_game(){
            game_active = true;
            game_state = Array(9).fill().map(() => Array(9).fill(0));
            col_top_index = [8,8,8,8,8,8,8,8,8];
            set_next_number();
            update_display();
        }


        function sleep(milliseconds) {
            const date = Date.now();
            let currentDate = null;
            do {
              currentDate = Date.now();
            } while (currentDate - date < milliseconds);
          }


        function set_next_number(){
            next_number = random();
            //next_number = 9;
            next_number_display.innerHTML = next_number;
        }

        


        function check_row(row){

            let flag = [0,0,0,0,0,0,0,0,0]

            for (let i = 0; i < 9; i++){
                if (game_state[row][i] === 0){
                    return false;
                }
                flag[Math.abs(game_state[row][i]) -1 ]++;
            }

            for (let i = 0; i < 9; i++){
                if(flag[i] === 0 || flag[i] > 1){
                    return false;
                }
            }
            console.log("row check true");
            //set delete value to -ve
            for (let i = 0; i < 9; i++){
                game_state[row][i] = -1 * Math.abs(game_state[row][i]);
            }
            return true
        
        }

        function check_col(col){

            if (game_state[0][col] === 0){
                return false;
            }

            let flag = [0,0,0,0,0,0,0,0,0];

            for (let i = 0; i < 9; i++){
                if (game_state[i][col] === 0){
                    return false;
                }
                
                flag[Math.abs(game_state[i][col]) -1 ]++;
            }

            for (let i = 0; i < 9; i++){
                if(flag[i] === 0 || flag[i] > 1){
                    return false;
                }
            console.log("col check true");
            for (let i = 0; i < 9; i++){
                game_state[i][col] = -1 * Math.abs(game_state[i][col]);
            }
            return true
            }   
        }

        //checks 3*3 sub-square where row,col is 0,0 of sub-square; 
        //if subsquare not possible return false 
        function check_box(row,col){
            if (row > 6 || col > 6){
                return false;
            }

            let flag = [0,0,0,0,0,0,0,0,0];

            for (let i = 0; i < 3; i++){
                for (let j = 0; j < 3; j++){
                    if (game_state[i+row][j+col] === 0){
                        return false;
                    }

                    flag[Math.abs(game_state[i+row][j+col]) -1 ]++;

                }
            }


            for (let i = 0; i < 9; i++){
                if(flag[i] === 0 || flag[i] > 1){
                    return false;
                }
            console.log("square check true");
            for (let i = 0; i < 3; i++){
                for (let j = 0; j < 3; j++){
                    game_state[i+row][j+col] = -1 *Math.abs(game_state[i+row][j+col]);
                }
            }
            return true
            }  

        }


        function check_game_state(row=-1,col=-1,flag=1){

            let del_flag = false;

            if(flag === -1){
                //check whole board row

                for (let i = 0; i<8; i++){
                    if (check_row(i) === true){
                        del_flag = true;
                    }  
                }

                //check whole board col

                for (let i = 0; i<8; i++){
                    if (check_col(i) === true){
                        del_flag = true;
                    }  
                }
                
                //check whole board box

                for (let i = 0; i<7; i++){
                    for(let j = 0; j<7; j++){
                        if (check_box(i,j) === true){
                            del_flag = true;
                        }
                    }  
                }
            }

            else{
                if (check_row(row) === true){
                    del_flag = true;
                }

                if (check_col(col) === true){
                    del_flag = true;
                }

                if (check_box(row,col) === true){
                    del_flag = true;
                }

            }

            return del_flag;
        }

        function update_display(){

            if (next_number === 0){
                next_number_display.innerHTML = "";
            }
            let x;
            for (let i=0; i < 9; i++){
                for (let j=0; j < 9; j++){
                    x = document.querySelector(`div[data-cell-index="${i}${j}"]`);
                    x.className = "cell";
                    x.innerHTML = game_state[i][j] === 0 ? "":Math.abs(game_state[i][j]);

                    if(game_state[i][j] < 0){
                        x.classList.add("del--cell")
                    }
                }
            }
        }

        function clean_board(){
            //sleep(3000);
            for (let i = 0; i<9; i++){
                for(let j = 0; j < 9; j++){
                    if (game_state[i][j] < 0){
                        game_state[i][j] = 0
                    }
                }
            }

            update_display();
            //sleep(3000);
        
            for (let j = 0; j<9; j++){
                let k = 8;
                for(let i = 8; i>=0; i--){
                    if (game_state[i][j] != 0){
                        game_state[k--][j] = game_state[i][j];
                    }
                }
                col_top_index[j] = k
                for (;k>=0;k--){
                    game_state[k][j] = 0
                }
            }
        }

        function board_check(row,col){
            let del_flag = check_game_state(row,col)
            while (del_flag === true){
                update_display();
                //console.log("updated with del");
                clean_board();
                //console.log("board clean");
                del_flag = check_game_state(-1,-1,-1);
                }
            update_display();
        }

        function handle_click(clickedCellEvent) {
            const clicked_cell = clickedCellEvent.target;
            let column_id = parseInt(clicked_cell.getAttribute('data-col-index'));

            if (game_active === false) {
                return;
            }
            // if column is full
            if (col_top_index[column_id] === -1){
                return;
            }

            let row_id = col_top_index[column_id];
            col_top_index[column_id]--;
            game_state[row_id][column_id] = next_number;
            
            next_number = 0;
            update_display();
            //console.log(JSON.parse(JSON.stringify(game_state)));
            //sleep(5000);
            board_check(row_id,column_id);
            set_next_number();
        }

        update_display();
        set_next_number();
        document.querySelectorAll('.game--column').forEach(cell => cell.addEventListener('click', handle_click));
        document.querySelector('.game--restart').addEventListener('click', restart_game);


    </script>


